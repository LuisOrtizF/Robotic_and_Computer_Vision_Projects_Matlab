<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="115,117" id="srcline117">117</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="115,118" id="srcline118">118</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="115,119" id="srcline119">119</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S22T31U172">v1</span>,<span class="var type1" id="S23T31U173">v2</span>] = edgeOrientations(<span class="var type1" id="S24T2U176">img_angle</span>,<span class="var type1" id="S25T2U177">img_weight</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="115,120" id="srcline120">120</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="115,121" id="srcline121">121</a></span><span class="line">    <span class="comment">% init v1 and v2</span></span></span>
<span class="srcline"><span class="lineno"><a href="115,122" id="srcline122">122</a></span><span class="line">    <span class="mxinfo " id="T31:U5"><span class="var type1" id="S22T31U180">v1</span> = <span class="mxinfo " id="T31:U7">[<span class="mxinfo " id="T6:U8">0</span> <span class="mxinfo " id="T6:U9">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,123" id="srcline123">123</a></span><span class="line">    <span class="mxinfo " id="T31:U10"><span class="var type1" id="S23T31U187">v2</span> = <span class="mxinfo " id="T31:U12">[<span class="mxinfo " id="T6:U13">0</span> <span class="mxinfo " id="T6:U14">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,124" id="srcline124">124</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="115,125" id="srcline125">125</a></span><span class="line">    <span class="comment">% number of bins (histogram parameter)</span></span></span>
<span class="srcline"><span class="lineno"><a href="115,126" id="srcline126">126</a></span><span class="line">    <span class="mxinfo " id="T6:U15"><span class="var type1" id="S26T6U194">bin_num</span> = <span class="mxinfo " id="T6:U17">32</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,127" id="srcline127">127</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="115,128" id="srcline128">128</a></span><span class="line">    <span class="comment">% convert images to vectors</span></span></span>
<span class="srcline"><span class="lineno"><a href="115,129" id="srcline129">129</a></span><span class="line">    <span class="mxinfo " id="T13:U18"><span class="var type1" id="S27T13U198">vec_angle</span>  = <span class="mxinfo " id="T13:U20"><span class="var type1" id="S24T2U200">img_angle</span>(:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,130" id="srcline130">130</a></span><span class="line">    <span class="mxinfo " id="T13:U22"><span class="var type1" id="S28T13U204">vec_weight</span> = <span class="mxinfo " id="T13:U24"><span class="var type1" id="S25T2U206">img_weight</span>(:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,131" id="srcline131">131</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="115,132" id="srcline132">132</a></span><span class="line">    <span class="comment">% convert angles from normals to directions</span></span></span>
<span class="srcline"><span class="lineno"><a href="115,133" id="srcline133">133</a></span><span class="line">    <span class="mxinfo " id="T13:U26"><span class="var type1" id="S27T13U210">vec_angle</span> = <span class="mxinfo " id="T13:U28"><span class="var type1" id="S27T13U212">vec_angle</span>+<span class="mxinfo " id="T6:U30"><span class="mxinfo " id="T6:U31">pi</span>/<span class="mxinfo " id="T6:U32">2</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,134" id="srcline134">134</a></span><span class="line">    <span class="mxinfo " id="T13:U33"><span class="mxinfo " id="T13:U34"><span class="var type1" id="S27T13U220">vec_angle</span>(<span class="mxinfo " id="T12:U36"><span class="var type1" id="S27T13U222">vec_angle</span>&gt;<span class="mxinfo " id="T6:U38">pi</span></span>)</span> = <span class="mxinfo " id="T13:U39"><span class="mxinfo " id="T13:U40"><span class="var type1" id="S27T13U227">vec_angle</span>(<span class="mxinfo " id="T12:U42"><span class="var type1" id="S27T13U229">vec_angle</span>&gt;<span class="mxinfo " id="T6:U44">pi</span></span>)</span>-<span class="mxinfo " id="T6:U45">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,135" id="srcline135">135</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="115,136" id="srcline136">136</a></span><span class="line">    <span class="comment">% create histogram</span></span></span>
<span class="srcline"><span class="lineno"><a href="115,137" id="srcline137">137</a></span><span class="line">    <span class="mxinfo " id="T145:U46"><span class="var type1" id="S30T145U236">angle_hist</span> = <span class="mxinfo " id="T145:U48">zeros(<span class="mxinfo " id="T6:U49">1</span>,<span class="var type1" id="S26T6U240">bin_num</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,138" id="srcline138">138</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="115,139" id="srcline139">139</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S32T6U243">i</span>=<span class="mxinfo " id="T6:U52">1</span>:length(<span class="var type1" id="S27T13U248">vec_angle</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="115,140" id="srcline140">140</a></span><span class="line">      <span class="mxinfo " id="T6:U54"><span class="var type1" id="S34T6U251">bin</span> = <span class="mxinfo " id="T6:U56"><span class="mxinfo " id="T6:U57">max(<span class="mxinfo " id="T6:U58">min(<span class="mxinfo " id="T6:U59">floor(<span class="mxinfo " id="T6:U60"><span class="mxinfo " id="T6:U61"><span class="var type1" id="S27T13U261">vec_angle</span>(<span class="var type1" id="S32T6U262">i</span>)</span>/(<span class="mxinfo " id="T6:U64">pi/<span class="var type1" id="S26T6U267">bin_num</span></span>)</span>)</span>,<span class="mxinfo " id="T6:U66"><span class="var type1" id="S26T6U269">bin_num</span>-1</span>)</span>,<span class="mxinfo " id="T6:U68">0</span>)</span>+<span class="mxinfo " id="T6:U69">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,141" id="srcline141">141</a></span><span class="line">      <span class="mxinfo " id="T6:U70"><span class="mxinfo " id="T6:U71"><span class="var type1" id="S30T145U276">angle_hist</span>(<span class="var type1" id="S34T6U277">bin</span>)</span> = <span class="mxinfo " id="T6:U74"><span class="mxinfo " id="T6:U75"><span class="var type1" id="S30T145U280">angle_hist</span>(<span class="var type1" id="S34T6U281">bin</span>)</span>+<span class="mxinfo " id="T6:U78"><span class="var type1" id="S28T13U283">vec_weight</span>(<span class="var type1" id="S32T6U284">i</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,142" id="srcline142">142</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="115,143" id="srcline143">143</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="115,144" id="srcline144">144</a></span><span class="line">    <span class="comment">% find modes of smoothed histogram</span></span></span>
<span class="srcline"><span class="lineno"><a href="115,145" id="srcline145">145</a></span><span class="line">    [<span class="var type1" id="S38T2U288">modesxx</span>,<span class="mxinfo " id="T145:U82">~</span>] = <span class="fcn" id="F806N9:B291">findModesMeanShift</span>(<span class="var type1" id="S30T145U292">angle_hist</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="115,146" id="srcline146">146</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="115,147" id="srcline147">147</a></span><span class="line">    <span class="comment">% if only one or no mode =&gt; return invalid corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="115,148" id="srcline148">148</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T10:U84"><span class="mxinfo " id="T6:U85">size(<span class="var type1" id="S38T2U299">modesxx</span>,1)</span>&lt;=<span class="mxinfo " id="T6:U87">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="115,149" id="srcline149">149</a></span><span class="line">      <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,150" id="srcline150">150</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="115,151" id="srcline151">151</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="115,152" id="srcline152">152</a></span><span class="line">    <span class="mxinfo " id="T153:U88"><span class="var type1" id="S41T153U305">modes</span>=<span class="mxinfo " id="T153:U90">zeros(<span class="mxinfo " id="T6:U91">length(<span class="mxinfo " id="T13:U92"><span class="var type1" id="S38T2U311">modesxx</span>(<span class="mxinfo " id="T47:U94">:</span>,<span class="mxinfo " id="T6:U95">1</span>)</span>)</span>,<span class="mxinfo " id="T6:U96">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,153" id="srcline153">153</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="115,154" id="srcline154">154</a></span><span class="line">    <span class="mxinfo " id="T13:U97"><span class="mxinfo " id="T13:U98"><span class="var type1" id="S41T153U318">modes</span>(<span class="mxinfo " id="T47:U100">:</span>,<span class="mxinfo " id="T16:U101">1</span>)</span>=<span class="mxinfo " id="T13:U102"><span class="var type1" id="S38T2U322">modesxx</span>(<span class="mxinfo " id="T47:U104">:</span>,<span class="mxinfo " id="T6:U105">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,155" id="srcline155">155</a></span><span class="line">    <span class="mxinfo " id="T13:U106"><span class="mxinfo " id="T13:U107"><span class="var type1" id="S41T153U328">modes</span>(<span class="mxinfo " id="T47:U109">:</span>,<span class="mxinfo " id="T16:U110">2</span>)</span>=<span class="mxinfo " id="T13:U111"><span class="var type1" id="S38T2U332">modesxx</span>(<span class="mxinfo " id="T47:U113">:</span>,<span class="mxinfo " id="T6:U114">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,156" id="srcline156">156</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="115,157" id="srcline157">157</a></span><span class="line">    <span class="comment">% compute orientation at modes</span></span></span>
<span class="srcline"><span class="lineno"><a href="115,158" id="srcline158">158</a></span><span class="line">    <span class="mxinfo " id="T13:U115"><span class="mxinfo " id="T13:U116"><span class="var type1" id="S41T153U338">modes</span>(<span class="mxinfo " id="T47:U118">:</span>,<span class="mxinfo " id="T16:U119">3</span>)</span> = <span class="mxinfo " id="T13:U120"><span class="mxinfo " id="T13:U121">(<span class="mxinfo " id="T13:U122"><span class="mxinfo " id="T13:U123"><span class="var type1" id="S38T2U346">modesxx</span>(<span class="mxinfo " id="T47:U125">:</span>,<span class="mxinfo " id="T6:U126">1</span>)</span>-<span class="mxinfo " id="T6:U127">1</span></span>)*<span class="mxinfo " id="T6:U128">pi</span></span>/<span class="var type1" id="S26T6U352">bin_num</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,159" id="srcline159">159</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="115,160" id="srcline160">160</a></span><span class="line">    <span class="comment">% extract 2 strongest modes and sort by angle</span></span></span>
<span class="srcline"><span class="lineno"><a href="115,161" id="srcline161">161</a></span><span class="line">    <span class="mxinfo " id="T154:U130"><span class="var type1" id="S41T154U355">modes</span> = <span class="mxinfo " id="T154:U132"><span class="var type1" id="S41T153U357">modes</span>(<span class="mxinfo " id="T31:U134"><span class="mxinfo " id="T6:U135">1</span>:<span class="mxinfo " id="T6:U136">2</span></span>,<span class="mxinfo " id="T155:U137">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,162" id="srcline162">162</a></span><span class="line">    [<span class="mxinfo " id="T6:U138">~</span>, <span class="var type1" id="S42T124U366">idx</span>] = sort(<span class="mxinfo " id="T124:U140"><span class="var type1" id="S41T154U370">modes</span>(<span class="mxinfo " id="T46:U142">:</span>,<span class="mxinfo " id="T16:U143">3</span>)</span>,1,<span class="string">'ascend'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="115,163" id="srcline163">163</a></span><span class="line">    <span class="mxinfo " id="T154:U144"><span class="var type1" id="S41T154U377">modes</span> = <span class="mxinfo " id="T154:U146"><span class="var type1" id="S41T154U379">modes</span>(<span class="var type1" id="S42T124U380">idx</span>,<span class="mxinfo " id="T155:U149">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,164" id="srcline164">164</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="115,165" id="srcline165">165</a></span><span class="line">    <span class="comment">% compute angle between modes</span></span></span>
<span class="srcline"><span class="lineno"><a href="115,166" id="srcline166">166</a></span><span class="line">    <span class="mxinfo " id="T6:U150"><span class="var type1" id="S44T6U384">delta_angle</span> = <span class="mxinfo " id="T6:U152">min(<span class="mxinfo " id="T6:U153"><span class="mxinfo " id="T6:U154"><span class="var type1" id="S41T154U389">modes</span>(<span class="mxinfo " id="T16:U156">2</span>,<span class="mxinfo " id="T16:U157">3</span>)</span>-<span class="mxinfo " id="T6:U158"><span class="var type1" id="S41T154U393">modes</span>(<span class="mxinfo " id="T6:U160">1</span>,<span class="mxinfo " id="T6:U161">3</span>)</span></span>,<span class="mxinfo " id="T6:U162"><span class="mxinfo " id="T6:U163"><span class="mxinfo " id="T6:U164"><span class="var type1" id="S41T154U399">modes</span>(<span class="mxinfo " id="T16:U166">1</span>,<span class="mxinfo " id="T16:U167">3</span>)</span>+<span class="mxinfo " id="T6:U168">pi</span></span>-<span class="mxinfo " id="T6:U169"><span class="var type1" id="S41T154U405">modes</span>(<span class="mxinfo " id="T6:U171">2</span>,<span class="mxinfo " id="T6:U172">3</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,167" id="srcline167">167</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="115,168" id="srcline168">168</a></span><span class="line">    <span class="comment">% if angle too small =&gt; return invalid corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="115,169" id="srcline169">169</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T10:U173"><span class="var type1" id="S44T6U411">delta_angle</span>&lt;=<span class="mxinfo " id="T6:U175">0.3</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="115,170" id="srcline170">170</a></span><span class="line">      <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,171" id="srcline171">171</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="115,172" id="srcline172">172</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="115,173" id="srcline173">173</a></span><span class="line">    <span class="comment">% set statistics: orientations</span></span></span>
<span class="srcline"><span class="lineno"><a href="115,174" id="srcline174">174</a></span><span class="line">    <span class="mxinfo " id="T31:U176"><span class="var type1" id="S22T31U416">v1</span> = <span class="mxinfo " id="T31:U178">[<span class="mxinfo " id="T6:U179">cos(<span class="mxinfo " id="T6:U180"><span class="var type1" id="S41T154U422">modes</span>(<span class="mxinfo " id="T16:U182">1</span>,<span class="mxinfo " id="T16:U183">3</span>)</span>)</span> <span class="mxinfo " id="T6:U184">sin(<span class="mxinfo " id="T6:U185"><span class="var type1" id="S41T154U428">modes</span>(<span class="mxinfo " id="T16:U187">1</span>,<span class="mxinfo " id="T16:U188">3</span>)</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,175" id="srcline175">175</a></span><span class="line">    <span class="mxinfo " id="T31:U189"><span class="var type1" id="S23T31U433">v2</span> = <span class="mxinfo " id="T31:U191">[<span class="mxinfo " id="T6:U192">cos(<span class="mxinfo " id="T6:U193"><span class="var type1" id="S41T154U439">modes</span>(<span class="mxinfo " id="T16:U195">2</span>,<span class="mxinfo " id="T16:U196">3</span>)</span>)</span> <span class="mxinfo " id="T6:U197">sin(<span class="mxinfo " id="T6:U198"><span class="var type1" id="S41T154U445">modes</span>(<span class="mxinfo " id="T16:U200">2</span>,<span class="mxinfo " id="T16:U201">3</span>)</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="115,176" id="srcline176">176</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="115,177" id="srcline177">177</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
