<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="103,117" id="srcline117">117</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="103,118" id="srcline118">118</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="103,119" id="srcline119">119</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S22T46U172">v1</span>,<span class="var type1" id="S23T46U173">v2</span>] = edgeOrientations(<span class="var type1" id="S24T1U176">img_angle</span>,<span class="var type1" id="S25T1U177">img_weight</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="103,120" id="srcline120">120</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="103,121" id="srcline121">121</a></span><span class="line">    <span class="comment">% init v1 and v2</span></span></span>
<span class="srcline"><span class="lineno"><a href="103,122" id="srcline122">122</a></span><span class="line">    <span class="mxinfo " id="T46:U5"><span class="var type1" id="S22T46U180">v1</span> = <span class="mxinfo " id="T46:U7">[<span class="mxinfo " id="T5:U8">0</span> <span class="mxinfo " id="T5:U9">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,123" id="srcline123">123</a></span><span class="line">    <span class="mxinfo " id="T46:U10"><span class="var type1" id="S23T46U187">v2</span> = <span class="mxinfo " id="T46:U12">[<span class="mxinfo " id="T5:U13">0</span> <span class="mxinfo " id="T5:U14">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,124" id="srcline124">124</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="103,125" id="srcline125">125</a></span><span class="line">    <span class="comment">% number of bins (histogram parameter)</span></span></span>
<span class="srcline"><span class="lineno"><a href="103,126" id="srcline126">126</a></span><span class="line">    <span class="mxinfo " id="T5:U15"><span class="var type1" id="S26T5U194">bin_num</span> = <span class="mxinfo " id="T5:U17">32</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,127" id="srcline127">127</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="103,128" id="srcline128">128</a></span><span class="line">    <span class="comment">% convert images to vectors</span></span></span>
<span class="srcline"><span class="lineno"><a href="103,129" id="srcline129">129</a></span><span class="line">    <span class="mxinfo " id="T4:U18"><span class="var type1" id="S27T4U198">vec_angle</span>  = <span class="mxinfo " id="T4:U20"><span class="var type1" id="S24T1U200">img_angle</span>(:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,130" id="srcline130">130</a></span><span class="line">    <span class="mxinfo " id="T4:U22"><span class="var type1" id="S28T4U204">vec_weight</span> = <span class="mxinfo " id="T4:U24"><span class="var type1" id="S25T1U206">img_weight</span>(:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,131" id="srcline131">131</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="103,132" id="srcline132">132</a></span><span class="line">    <span class="comment">% convert angles from normals to directions</span></span></span>
<span class="srcline"><span class="lineno"><a href="103,133" id="srcline133">133</a></span><span class="line">    <span class="mxinfo " id="T4:U26"><span class="var type1" id="S27T4U210">vec_angle</span> = <span class="mxinfo " id="T4:U28"><span class="var type1" id="S27T4U212">vec_angle</span>+<span class="mxinfo " id="T5:U30"><span class="mxinfo " id="T5:U31">pi</span>/<span class="mxinfo " id="T5:U32">2</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,134" id="srcline134">134</a></span><span class="line">    <span class="mxinfo " id="T4:U33"><span class="mxinfo " id="T4:U34"><span class="var type1" id="S27T4U220">vec_angle</span>(<span class="mxinfo " id="T85:U36"><span class="var type1" id="S27T4U222">vec_angle</span>&gt;<span class="mxinfo " id="T5:U38">pi</span></span>)</span> = <span class="mxinfo " id="T4:U39"><span class="mxinfo " id="T4:U40"><span class="var type1" id="S27T4U227">vec_angle</span>(<span class="mxinfo " id="T85:U42"><span class="var type1" id="S27T4U229">vec_angle</span>&gt;<span class="mxinfo " id="T5:U44">pi</span></span>)</span>-<span class="mxinfo " id="T5:U45">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,135" id="srcline135">135</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="103,136" id="srcline136">136</a></span><span class="line">    <span class="comment">% create histogram</span></span></span>
<span class="srcline"><span class="lineno"><a href="103,137" id="srcline137">137</a></span><span class="line">    <span class="mxinfo " id="T83:U46"><span class="var type1" id="S30T83U236">angle_hist</span> = <span class="mxinfo " id="T83:U48">zeros(<span class="mxinfo " id="T5:U49">1</span>,<span class="var type1" id="S26T5U240">bin_num</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,138" id="srcline138">138</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="103,139" id="srcline139">139</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S32T5U243">i</span>=<span class="mxinfo " id="T5:U52">1</span>:length(<span class="var type1" id="S27T4U248">vec_angle</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="103,140" id="srcline140">140</a></span><span class="line">      <span class="mxinfo " id="T5:U54"><span class="var type1" id="S34T5U251">bin</span> = <span class="mxinfo " id="T5:U56"><span class="mxinfo " id="T5:U57">max(<span class="mxinfo " id="T5:U58">min(<span class="mxinfo " id="T5:U59">floor(<span class="mxinfo " id="T5:U60"><span class="mxinfo " id="T5:U61"><span class="var type1" id="S27T4U261">vec_angle</span>(<span class="var type1" id="S32T5U262">i</span>)</span>/(<span class="mxinfo " id="T5:U64">pi/<span class="var type1" id="S26T5U267">bin_num</span></span>)</span>)</span>,<span class="mxinfo " id="T5:U66"><span class="var type1" id="S26T5U269">bin_num</span>-1</span>)</span>,<span class="mxinfo " id="T5:U68">0</span>)</span>+<span class="mxinfo " id="T5:U69">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,141" id="srcline141">141</a></span><span class="line">      <span class="mxinfo " id="T5:U70"><span class="mxinfo " id="T5:U71"><span class="var type1" id="S30T83U276">angle_hist</span>(<span class="var type1" id="S34T5U277">bin</span>)</span> = <span class="mxinfo " id="T5:U74"><span class="mxinfo " id="T5:U75"><span class="var type1" id="S30T83U280">angle_hist</span>(<span class="var type1" id="S34T5U281">bin</span>)</span>+<span class="mxinfo " id="T5:U78"><span class="var type1" id="S28T4U283">vec_weight</span>(<span class="var type1" id="S32T5U284">i</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,142" id="srcline142">142</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="103,143" id="srcline143">143</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="103,144" id="srcline144">144</a></span><span class="line">    <span class="comment">% find modes of smoothed histogram</span></span></span>
<span class="srcline"><span class="lineno"><a href="103,145" id="srcline145">145</a></span><span class="line">    [<span class="var type1" id="S38T1U288">modesxx</span>,<span class="mxinfo " id="T83:U82">~</span>] = <span class="fcn" id="F445N10:B291">findModesMeanShift</span>(<span class="var type1" id="S30T83U292">angle_hist</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="103,146" id="srcline146">146</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="103,147" id="srcline147">147</a></span><span class="line">    <span class="comment">% if only one or no mode =&gt; return invalid corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="103,148" id="srcline148">148</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T7:U84"><span class="mxinfo " id="T5:U85">size(<span class="var type1" id="S38T1U299">modesxx</span>,1)</span>&lt;=<span class="mxinfo " id="T5:U87">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="103,149" id="srcline149">149</a></span><span class="line">      <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,150" id="srcline150">150</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="103,151" id="srcline151">151</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="103,152" id="srcline152">152</a></span><span class="line">    <span class="mxinfo " id="T94:U88"><span class="var type1" id="S41T94U305">modes</span>=<span class="mxinfo " id="T94:U90">zeros(<span class="mxinfo " id="T5:U91">length(<span class="mxinfo " id="T4:U92"><span class="var type1" id="S38T1U311">modesxx</span>(<span class="mxinfo " id="T86:U94">:</span>,<span class="mxinfo " id="T5:U95">1</span>)</span>)</span>,<span class="mxinfo " id="T5:U96">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,153" id="srcline153">153</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="103,154" id="srcline154">154</a></span><span class="line">    <span class="mxinfo " id="T4:U97"><span class="mxinfo " id="T4:U98"><span class="var type1" id="S41T94U318">modes</span>(<span class="mxinfo " id="T86:U100">:</span>,<span class="mxinfo " id="T26:U101">1</span>)</span>=<span class="mxinfo " id="T4:U102"><span class="var type1" id="S38T1U322">modesxx</span>(<span class="mxinfo " id="T86:U104">:</span>,<span class="mxinfo " id="T5:U105">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,155" id="srcline155">155</a></span><span class="line">    <span class="mxinfo " id="T4:U106"><span class="mxinfo " id="T4:U107"><span class="var type1" id="S41T94U328">modes</span>(<span class="mxinfo " id="T86:U109">:</span>,<span class="mxinfo " id="T26:U110">2</span>)</span>=<span class="mxinfo " id="T4:U111"><span class="var type1" id="S38T1U332">modesxx</span>(<span class="mxinfo " id="T86:U113">:</span>,<span class="mxinfo " id="T5:U114">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,156" id="srcline156">156</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="103,157" id="srcline157">157</a></span><span class="line">    <span class="comment">% compute orientation at modes</span></span></span>
<span class="srcline"><span class="lineno"><a href="103,158" id="srcline158">158</a></span><span class="line">    <span class="mxinfo " id="T4:U115"><span class="mxinfo " id="T4:U116"><span class="var type1" id="S41T94U338">modes</span>(<span class="mxinfo " id="T86:U118">:</span>,<span class="mxinfo " id="T26:U119">3</span>)</span> = <span class="mxinfo " id="T4:U120"><span class="mxinfo " id="T4:U121">(<span class="mxinfo " id="T4:U122"><span class="mxinfo " id="T4:U123"><span class="var type1" id="S38T1U346">modesxx</span>(<span class="mxinfo " id="T86:U125">:</span>,<span class="mxinfo " id="T5:U126">1</span>)</span>-<span class="mxinfo " id="T5:U127">1</span></span>)*<span class="mxinfo " id="T5:U128">pi</span></span>/<span class="var type1" id="S26T5U352">bin_num</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,159" id="srcline159">159</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="103,160" id="srcline160">160</a></span><span class="line">    <span class="comment">% extract 2 strongest modes and sort by angle</span></span></span>
<span class="srcline"><span class="lineno"><a href="103,161" id="srcline161">161</a></span><span class="line">    <span class="mxinfo " id="T95:U130"><span class="var type1" id="S41T95U355">modes</span> = <span class="mxinfo " id="T95:U132"><span class="var type1" id="S41T94U357">modes</span>(<span class="mxinfo " id="T46:U134"><span class="mxinfo " id="T5:U135">1</span>:<span class="mxinfo " id="T5:U136">2</span></span>,<span class="mxinfo " id="T96:U137">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,162" id="srcline162">162</a></span><span class="line">    [<span class="mxinfo " id="T5:U138">~</span>, <span class="var type1" id="S42T51U366">idx</span>] = sort(<span class="mxinfo " id="T51:U140"><span class="var type1" id="S41T95U370">modes</span>(<span class="mxinfo " id="T42:U142">:</span>,<span class="mxinfo " id="T26:U143">3</span>)</span>,1,<span class="string">'ascend'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="103,163" id="srcline163">163</a></span><span class="line">    <span class="mxinfo " id="T95:U144"><span class="var type1" id="S41T95U377">modes</span> = <span class="mxinfo " id="T95:U146"><span class="var type1" id="S41T95U379">modes</span>(<span class="var type1" id="S42T51U380">idx</span>,<span class="mxinfo " id="T96:U149">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,164" id="srcline164">164</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="103,165" id="srcline165">165</a></span><span class="line">    <span class="comment">% compute angle between modes</span></span></span>
<span class="srcline"><span class="lineno"><a href="103,166" id="srcline166">166</a></span><span class="line">    <span class="mxinfo " id="T5:U150"><span class="var type1" id="S44T5U384">delta_angle</span> = <span class="mxinfo " id="T5:U152">min(<span class="mxinfo " id="T5:U153"><span class="mxinfo " id="T5:U154"><span class="var type1" id="S41T95U389">modes</span>(<span class="mxinfo " id="T26:U156">2</span>,<span class="mxinfo " id="T26:U157">3</span>)</span>-<span class="mxinfo " id="T5:U158"><span class="var type1" id="S41T95U393">modes</span>(<span class="mxinfo " id="T5:U160">1</span>,<span class="mxinfo " id="T5:U161">3</span>)</span></span>,<span class="mxinfo " id="T5:U162"><span class="mxinfo " id="T5:U163"><span class="mxinfo " id="T5:U164"><span class="var type1" id="S41T95U399">modes</span>(<span class="mxinfo " id="T26:U166">1</span>,<span class="mxinfo " id="T26:U167">3</span>)</span>+<span class="mxinfo " id="T5:U168">pi</span></span>-<span class="mxinfo " id="T5:U169"><span class="var type1" id="S41T95U405">modes</span>(<span class="mxinfo " id="T5:U171">2</span>,<span class="mxinfo " id="T5:U172">3</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,167" id="srcline167">167</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="103,168" id="srcline168">168</a></span><span class="line">    <span class="comment">% if angle too small =&gt; return invalid corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="103,169" id="srcline169">169</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T7:U173"><span class="var type1" id="S44T5U411">delta_angle</span>&lt;=<span class="mxinfo " id="T5:U175">0.3</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="103,170" id="srcline170">170</a></span><span class="line">      <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,171" id="srcline171">171</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="103,172" id="srcline172">172</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="103,173" id="srcline173">173</a></span><span class="line">    <span class="comment">% set statistics: orientations</span></span></span>
<span class="srcline"><span class="lineno"><a href="103,174" id="srcline174">174</a></span><span class="line">    <span class="mxinfo " id="T46:U176"><span class="var type1" id="S22T46U416">v1</span> = <span class="mxinfo " id="T46:U178">[<span class="mxinfo " id="T5:U179">cos(<span class="mxinfo " id="T5:U180"><span class="var type1" id="S41T95U422">modes</span>(<span class="mxinfo " id="T26:U182">1</span>,<span class="mxinfo " id="T26:U183">3</span>)</span>)</span> <span class="mxinfo " id="T5:U184">sin(<span class="mxinfo " id="T5:U185"><span class="var type1" id="S41T95U428">modes</span>(<span class="mxinfo " id="T26:U187">1</span>,<span class="mxinfo " id="T26:U188">3</span>)</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,175" id="srcline175">175</a></span><span class="line">    <span class="mxinfo " id="T46:U189"><span class="var type1" id="S23T46U433">v2</span> = <span class="mxinfo " id="T46:U191">[<span class="mxinfo " id="T5:U192">cos(<span class="mxinfo " id="T5:U193"><span class="var type1" id="S41T95U439">modes</span>(<span class="mxinfo " id="T26:U195">2</span>,<span class="mxinfo " id="T26:U196">3</span>)</span>)</span> <span class="mxinfo " id="T5:U197">sin(<span class="mxinfo " id="T5:U198"><span class="var type1" id="S41T95U445">modes</span>(<span class="mxinfo " id="T26:U200">2</span>,<span class="mxinfo " id="T26:U201">3</span>)</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="103,176" id="srcline176">176</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="103,177" id="srcline177">177</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
