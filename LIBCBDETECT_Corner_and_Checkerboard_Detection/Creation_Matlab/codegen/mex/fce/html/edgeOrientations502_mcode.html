<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="116,117" id="srcline117">117</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="116,118" id="srcline118">118</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="116,119" id="srcline119">119</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S22T51U172">v1</span>,<span class="var type1" id="S23T51U173">v2</span>] = edgeOrientations(<span class="var type1" id="S24T74U176">img_angle</span>,<span class="var type1" id="S25T74U177">img_weight</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="116,120" id="srcline120">120</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="116,121" id="srcline121">121</a></span><span class="line">    <span class="comment">% init v1 and v2</span></span></span>
<span class="srcline"><span class="lineno"><a href="116,122" id="srcline122">122</a></span><span class="line">    <span class="mxinfo " id="T51:U5"><span class="var type1" id="S22T51U180">v1</span> = <span class="mxinfo " id="T51:U7">[<span class="mxinfo " id="T8:U8">0</span> <span class="mxinfo " id="T8:U9">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,123" id="srcline123">123</a></span><span class="line">    <span class="mxinfo " id="T51:U10"><span class="var type1" id="S23T51U187">v2</span> = <span class="mxinfo " id="T51:U12">[<span class="mxinfo " id="T8:U13">0</span> <span class="mxinfo " id="T8:U14">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,124" id="srcline124">124</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="116,125" id="srcline125">125</a></span><span class="line">    <span class="comment">% number of bins (histogram parameter)</span></span></span>
<span class="srcline"><span class="lineno"><a href="116,126" id="srcline126">126</a></span><span class="line">    <span class="mxinfo " id="T8:U15"><span class="var type1" id="S26T8U194">bin_num</span> = <span class="mxinfo " id="T8:U17">32</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,127" id="srcline127">127</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="116,128" id="srcline128">128</a></span><span class="line">    <span class="comment">% convert images to vectors</span></span></span>
<span class="srcline"><span class="lineno"><a href="116,129" id="srcline129">129</a></span><span class="line">    <span class="mxinfo " id="T102:U18"><span class="var type1" id="S27T102U198">vec_angle</span>  = <span class="mxinfo " id="T102:U20"><span class="var type1" id="S24T74U200">img_angle</span>(:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,130" id="srcline130">130</a></span><span class="line">    <span class="mxinfo " id="T102:U22"><span class="var type1" id="S28T102U204">vec_weight</span> = <span class="mxinfo " id="T102:U24"><span class="var type1" id="S25T74U206">img_weight</span>(:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,131" id="srcline131">131</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="116,132" id="srcline132">132</a></span><span class="line">    <span class="comment">% convert angles from normals to directions</span></span></span>
<span class="srcline"><span class="lineno"><a href="116,133" id="srcline133">133</a></span><span class="line">    <span class="mxinfo " id="T102:U26"><span class="var type1" id="S27T102U210">vec_angle</span> = <span class="mxinfo " id="T102:U28"><span class="var type1" id="S27T102U212">vec_angle</span>+<span class="mxinfo " id="T8:U30"><span class="mxinfo " id="T8:U31">pi</span>/<span class="mxinfo " id="T8:U32">2</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,134" id="srcline134">134</a></span><span class="line">    <span class="mxinfo " id="T102:U33"><span class="mxinfo " id="T102:U34"><span class="var type1" id="S27T102U220">vec_angle</span>(<span class="mxinfo " id="T103:U36"><span class="var type1" id="S27T102U222">vec_angle</span>&gt;<span class="mxinfo " id="T8:U38">pi</span></span>)</span> = <span class="mxinfo " id="T102:U39"><span class="mxinfo " id="T102:U40"><span class="var type1" id="S27T102U227">vec_angle</span>(<span class="mxinfo " id="T103:U42"><span class="var type1" id="S27T102U229">vec_angle</span>&gt;<span class="mxinfo " id="T8:U44">pi</span></span>)</span>-<span class="mxinfo " id="T8:U45">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,135" id="srcline135">135</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="116,136" id="srcline136">136</a></span><span class="line">    <span class="comment">% create histogram</span></span></span>
<span class="srcline"><span class="lineno"><a href="116,137" id="srcline137">137</a></span><span class="line">    <span class="mxinfo " id="T90:U46"><span class="var type1" id="S30T90U236">angle_hist</span> = <span class="mxinfo " id="T90:U48">zeros(<span class="mxinfo " id="T8:U49">1</span>,<span class="var type1" id="S26T8U240">bin_num</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,138" id="srcline138">138</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="116,139" id="srcline139">139</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S32T8U243">i</span>=<span class="mxinfo " id="T8:U52">1</span>:length(<span class="var type1" id="S27T102U248">vec_angle</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="116,140" id="srcline140">140</a></span><span class="line">      <span class="mxinfo " id="T8:U54"><span class="var type1" id="S34T8U251">bin</span> = <span class="mxinfo " id="T8:U56"><span class="mxinfo " id="T8:U57">max(<span class="mxinfo " id="T8:U58">min(<span class="mxinfo " id="T8:U59">floor(<span class="mxinfo " id="T8:U60"><span class="mxinfo " id="T8:U61"><span class="var type1" id="S27T102U261">vec_angle</span>(<span class="var type1" id="S32T8U262">i</span>)</span>/(<span class="mxinfo " id="T8:U64">pi/<span class="var type1" id="S26T8U267">bin_num</span></span>)</span>)</span>,<span class="mxinfo " id="T8:U66"><span class="var type1" id="S26T8U269">bin_num</span>-1</span>)</span>,<span class="mxinfo " id="T8:U68">0</span>)</span>+<span class="mxinfo " id="T8:U69">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,141" id="srcline141">141</a></span><span class="line">      <span class="mxinfo " id="T8:U70"><span class="mxinfo " id="T8:U71"><span class="var type1" id="S30T90U276">angle_hist</span>(<span class="var type1" id="S34T8U277">bin</span>)</span> = <span class="mxinfo " id="T8:U74"><span class="mxinfo " id="T8:U75"><span class="var type1" id="S30T90U280">angle_hist</span>(<span class="var type1" id="S34T8U281">bin</span>)</span>+<span class="mxinfo " id="T8:U78"><span class="var type1" id="S28T102U283">vec_weight</span>(<span class="var type1" id="S32T8U284">i</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,142" id="srcline142">142</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="116,143" id="srcline143">143</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="116,144" id="srcline144">144</a></span><span class="line">    <span class="comment">% find modes of smoothed histogram</span></span></span>
<span class="srcline"><span class="lineno"><a href="116,145" id="srcline145">145</a></span><span class="line">    [<span class="var type1" id="S38T5U288">modesxx</span>,<span class="mxinfo " id="T90:U82">~</span>] = <span class="fcn" id="F480N10:B291">findModesMeanShift</span>(<span class="var type1" id="S30T90U292">angle_hist</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="116,146" id="srcline146">146</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="116,147" id="srcline147">147</a></span><span class="line">    <span class="comment">% if only one or no mode =&gt; return invalid corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="116,148" id="srcline148">148</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T10:U84"><span class="mxinfo " id="T8:U85">size(<span class="var type1" id="S38T5U299">modesxx</span>,1)</span>&lt;=<span class="mxinfo " id="T8:U87">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="116,149" id="srcline149">149</a></span><span class="line">      <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,150" id="srcline150">150</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="116,151" id="srcline151">151</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="116,152" id="srcline152">152</a></span><span class="line">    <span class="mxinfo " id="T104:U88"><span class="var type1" id="S41T104U305">modes</span>=<span class="mxinfo " id="T104:U90">zeros(<span class="mxinfo " id="T8:U91">length(<span class="mxinfo " id="T7:U92"><span class="var type1" id="S38T5U311">modesxx</span>(<span class="mxinfo " id="T93:U94">:</span>,<span class="mxinfo " id="T8:U95">1</span>)</span>)</span>,<span class="mxinfo " id="T8:U96">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,153" id="srcline153">153</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="116,154" id="srcline154">154</a></span><span class="line">    <span class="mxinfo " id="T7:U97"><span class="mxinfo " id="T7:U98"><span class="var type1" id="S41T104U318">modes</span>(<span class="mxinfo " id="T93:U100">:</span>,<span class="mxinfo " id="T29:U101">1</span>)</span>=<span class="mxinfo " id="T7:U102"><span class="var type1" id="S38T5U322">modesxx</span>(<span class="mxinfo " id="T93:U104">:</span>,<span class="mxinfo " id="T8:U105">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,155" id="srcline155">155</a></span><span class="line">    <span class="mxinfo " id="T7:U106"><span class="mxinfo " id="T7:U107"><span class="var type1" id="S41T104U328">modes</span>(<span class="mxinfo " id="T93:U109">:</span>,<span class="mxinfo " id="T29:U110">2</span>)</span>=<span class="mxinfo " id="T7:U111"><span class="var type1" id="S38T5U332">modesxx</span>(<span class="mxinfo " id="T93:U113">:</span>,<span class="mxinfo " id="T8:U114">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,156" id="srcline156">156</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="116,157" id="srcline157">157</a></span><span class="line">    <span class="comment">% compute orientation at modes</span></span></span>
<span class="srcline"><span class="lineno"><a href="116,158" id="srcline158">158</a></span><span class="line">    <span class="mxinfo " id="T7:U115"><span class="mxinfo " id="T7:U116"><span class="var type1" id="S41T104U338">modes</span>(<span class="mxinfo " id="T93:U118">:</span>,<span class="mxinfo " id="T29:U119">3</span>)</span> = <span class="mxinfo " id="T7:U120"><span class="mxinfo " id="T7:U121">(<span class="mxinfo " id="T7:U122"><span class="mxinfo " id="T7:U123"><span class="var type1" id="S38T5U346">modesxx</span>(<span class="mxinfo " id="T93:U125">:</span>,<span class="mxinfo " id="T8:U126">1</span>)</span>-<span class="mxinfo " id="T8:U127">1</span></span>)*<span class="mxinfo " id="T8:U128">pi</span></span>/<span class="var type1" id="S26T8U352">bin_num</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,159" id="srcline159">159</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="116,160" id="srcline160">160</a></span><span class="line">    <span class="comment">% extract 2 strongest modes and sort by angle</span></span></span>
<span class="srcline"><span class="lineno"><a href="116,161" id="srcline161">161</a></span><span class="line">    <span class="mxinfo " id="T105:U130"><span class="var type1" id="S41T105U355">modes</span> = <span class="mxinfo " id="T105:U132"><span class="var type1" id="S41T104U357">modes</span>(<span class="mxinfo " id="T51:U134"><span class="mxinfo " id="T8:U135">1</span>:<span class="mxinfo " id="T8:U136">2</span></span>,<span class="mxinfo " id="T106:U137">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,162" id="srcline162">162</a></span><span class="line">    [<span class="mxinfo " id="T8:U138">~</span>, <span class="var type1" id="S42T56U366">idx</span>] = sort(<span class="mxinfo " id="T56:U140"><span class="var type1" id="S41T105U370">modes</span>(<span class="mxinfo " id="T48:U142">:</span>,<span class="mxinfo " id="T29:U143">3</span>)</span>,1,<span class="string">'ascend'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="116,163" id="srcline163">163</a></span><span class="line">    <span class="mxinfo " id="T105:U144"><span class="var type1" id="S41T105U377">modes</span> = <span class="mxinfo " id="T105:U146"><span class="var type1" id="S41T105U379">modes</span>(<span class="var type1" id="S42T56U380">idx</span>,<span class="mxinfo " id="T106:U149">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,164" id="srcline164">164</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="116,165" id="srcline165">165</a></span><span class="line">    <span class="comment">% compute angle between modes</span></span></span>
<span class="srcline"><span class="lineno"><a href="116,166" id="srcline166">166</a></span><span class="line">    <span class="mxinfo " id="T8:U150"><span class="var type1" id="S44T8U384">delta_angle</span> = <span class="mxinfo " id="T8:U152">min(<span class="mxinfo " id="T8:U153"><span class="mxinfo " id="T8:U154"><span class="var type1" id="S41T105U389">modes</span>(<span class="mxinfo " id="T29:U156">2</span>,<span class="mxinfo " id="T29:U157">3</span>)</span>-<span class="mxinfo " id="T8:U158"><span class="var type1" id="S41T105U393">modes</span>(<span class="mxinfo " id="T8:U160">1</span>,<span class="mxinfo " id="T8:U161">3</span>)</span></span>,<span class="mxinfo " id="T8:U162"><span class="mxinfo " id="T8:U163"><span class="mxinfo " id="T8:U164"><span class="var type1" id="S41T105U399">modes</span>(<span class="mxinfo " id="T29:U166">1</span>,<span class="mxinfo " id="T29:U167">3</span>)</span>+<span class="mxinfo " id="T8:U168">pi</span></span>-<span class="mxinfo " id="T8:U169"><span class="var type1" id="S41T105U405">modes</span>(<span class="mxinfo " id="T8:U171">2</span>,<span class="mxinfo " id="T8:U172">3</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,167" id="srcline167">167</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="116,168" id="srcline168">168</a></span><span class="line">    <span class="comment">% if angle too small =&gt; return invalid corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="116,169" id="srcline169">169</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T10:U173"><span class="var type1" id="S44T8U411">delta_angle</span>&lt;=<span class="mxinfo " id="T8:U175">0.3</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="116,170" id="srcline170">170</a></span><span class="line">      <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,171" id="srcline171">171</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="116,172" id="srcline172">172</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="116,173" id="srcline173">173</a></span><span class="line">    <span class="comment">% set statistics: orientations</span></span></span>
<span class="srcline"><span class="lineno"><a href="116,174" id="srcline174">174</a></span><span class="line">    <span class="mxinfo " id="T51:U176"><span class="var type1" id="S22T51U416">v1</span> = <span class="mxinfo " id="T51:U178">[<span class="mxinfo " id="T8:U179">cos(<span class="mxinfo " id="T8:U180"><span class="var type1" id="S41T105U422">modes</span>(<span class="mxinfo " id="T29:U182">1</span>,<span class="mxinfo " id="T29:U183">3</span>)</span>)</span> <span class="mxinfo " id="T8:U184">sin(<span class="mxinfo " id="T8:U185"><span class="var type1" id="S41T105U428">modes</span>(<span class="mxinfo " id="T29:U187">1</span>,<span class="mxinfo " id="T29:U188">3</span>)</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,175" id="srcline175">175</a></span><span class="line">    <span class="mxinfo " id="T51:U189"><span class="var type1" id="S23T51U433">v2</span> = <span class="mxinfo " id="T51:U191">[<span class="mxinfo " id="T8:U192">cos(<span class="mxinfo " id="T8:U193"><span class="var type1" id="S41T105U439">modes</span>(<span class="mxinfo " id="T29:U195">2</span>,<span class="mxinfo " id="T29:U196">3</span>)</span>)</span> <span class="mxinfo " id="T8:U197">sin(<span class="mxinfo " id="T8:U198"><span class="var type1" id="S41T105U445">modes</span>(<span class="mxinfo " id="T29:U200">2</span>,<span class="mxinfo " id="T29:U201">3</span>)</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="116,176" id="srcline176">176</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="116,177" id="srcline177">177</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
